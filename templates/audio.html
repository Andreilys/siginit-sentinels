{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Audio Analysis</h5>
                </div>
                <div class="card-body">
                    <form id="audio-filter-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <select class="form-select" id="priority-filter">
                                    <option value="">Priority Level</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="reliability-filter">
                                    <option value="">Source Reliability</option>
                                    <option value="A">A - Completely reliable</option>
                                    <option value="B">B - Usually reliable</option>
                                    <option value="C">C - Fairly reliable</option>
                                    <option value="D">D - Not usually reliable</option>
                                    <option value="E">E - Unreliable</option>
                                    <option value="F">F - Cannot be judged</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="credibility-filter">
                                    <option value="">Information Credibility</option>
                                    <option value="ONE">1 - Confirmed</option>
                                    <option value="TWO">2 - Probably true</option>
                                    <option value="THREE">3 - Possibly true</option>
                                    <option value="FOUR">4 - Doubtful</option>
                                    <option value="FIVE">5 - Improbable</option>
                                    <option value="SIX">6 - Cannot be judged</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="location-filter" placeholder="Location search...">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="entity-filter" placeholder="Entity search...">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="duration-filter">
                                    <option value="">Conversation Duration</option>
                                    <option value="Short">Short</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Long">Long</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Conversation Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div id="conversation-results">
                        {% for conv in conversations %}
                        <div class="conversation-item mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">
                                    <span class="badge bg-{{ 'danger' if conv.priority_level == 'High' else 'warning' if conv.priority_level == 'Medium' else 'info' }}">
                                        {{ conv.priority_level }}
                                    </span>
                                </h5>
                                <small>{{ conv.analyzed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h6>Risk Assessment</h6>
                                    <p>{{ conv.risk_assessment }}</p>
                                    
                                    <h6>Key Insights</h6>
                                    <p>{{ conv.key_insights }}</p>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>Critical Entities</h6>
                                            <div>
                                                {% for entity in conv.critical_entities %}
                                                    <span class="badge bg-secondary me-1">{{ entity }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Locations Mentioned</h6>
                                            <div>
                                                {% for location in conv.locations_mentioned %}
                                                    <span class="badge bg-info me-1">{{ location }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6>Sentiment Summary</h6>
                                    <p>{{ conv.sentiment_summary }}</p>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <h6>Source Reliability</h6>
                                            <span class="badge bg-primary">{{ conv.source_reliability }}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Information Credibility</h6>
                                            <span class="badge bg-primary">{{ conv.information_credibility }}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Duration</h6>
                                            <span class="badge bg-secondary">{{ conv.conversation_duration }}</span>
                                        </div>
                                    </div>
                                    
                                    <h6>Recommended Actions</h6>
                                    <ul class="list-unstyled">
                                        {% for action in conv.recommended_actions %}
                                            <li><i class="fas fa-check-circle text-success"></i> {{ action }}</li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <h6>Entity Relationships</h6>
                                    <p>{{ conv.entity_relationships }}</p>
                                    
                                    <h6>Speakers</h6>
                                    <div>
                                        {% for speaker in conv.speakers %}
                                            <span class="badge bg-dark me-1">{{ speaker }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('audio-filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const filters = {
        priority: document.getElementById('priority-filter').value,
        reliability: document.getElementById('reliability-filter').value,
        credibility: document.getElementById('credibility-filter').value,
        location: document.getElementById('location-filter').value,
        entity: document.getElementById('entity-filter').value,
        duration: document.getElementById('duration-filter').value
    };
    
    // Apply filters to existing elements
    document.querySelectorAll('.conversation-item').forEach(item => {
        let show = true;
        
        if (filters.priority && !item.querySelector('.badge').textContent.trim().includes(filters.priority)) {
            show = false;
        }
        
        if (filters.reliability && !item.textContent.includes(filters.reliability)) {
            show = false;
        }
        
        if (filters.credibility && !item.textContent.includes(filters.credibility)) {
            show = false;
        }
        
        if (filters.location && !item.textContent.toLowerCase().includes(filters.location.toLowerCase())) {
            show = false;
        }
        
        if (filters.entity && !item.textContent.toLowerCase().includes(filters.entity.toLowerCase())) {
            show = false;
        }
        
        if (filters.duration && !item.textContent.includes(filters.duration)) {
            show = false;
        }
        
        item.style.display = show ? '' : 'none';
    });
});
</script>
{% endblock %}
